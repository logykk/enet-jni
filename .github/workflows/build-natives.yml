name: Build Native Libraries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux-x86-64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Build with Gradle
        run: ./gradlew enet-jniSharedLibrary
        
      - name: Upload Linux x86-64 library
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86-64-libs
          path: build/libs/enet-jni/shared/libenet-jni.so
          
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Gradle
        run: ./gradlew enet-jniSharedLibrary
        
      - name: Upload Linux ARM64 library
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-libs
          path: build/libs/enet-jni/shared/libenet-jni.so
          
  build-windows-x86-64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Build with Gradle
        run: ./gradlew enet-jniSharedLibrary
        
      - name: Upload Windows x86-64 library
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86-64-libs
          path: build/libs/enet-jni/shared/enet-jni.dll
          
  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Build with Gradle for ARM64
        run: |
          # Set environment for ARM64 cross-compilation
          export CFLAGS="-arch arm64"
          export LDFLAGS="-arch arm64"
          ./gradlew enet-jniSharedLibrary -PbuildArch=arm64
        
      - name: Upload macOS ARM64 library
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-libs
          path: build/libs/enet-jni/shared/libenet-jni.dylib
          
  package-all:
    needs: [build-linux-x86-64, build-linux-arm64, build-windows-x86-64, build-macos-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          
      - name: Create native directories
        run: |
          # x86-64 directories
          mkdir -p src/main/resources/natives/linux-x86-64
          mkdir -p src/main/resources/natives/windows-x86-64
          
          # arm64 directories
          mkdir -p src/main/resources/natives/linux-arm64
          mkdir -p src/main/resources/natives/macos-arm64
          
      # Download x86-64 libraries
      - name: Download Linux x86-64 library
        uses: actions/download-artifact@v4
        with:
          name: linux-x86-64-libs
          path: src/main/resources/natives/linux-x86-64
          
      - name: Download Windows x86-64 library
        uses: actions/download-artifact@v4
        with:
          name: windows-x86-64-libs
          path: src/main/resources/natives/windows-x86-64
          
      # Download arm64 libraries
      - name: Download Linux arm64 library
        uses: actions/download-artifact@v4
        with:
          name: linux-arm64-libs
          path: src/main/resources/natives/linux-arm64
          
      - name: Download macOS arm64 library
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-libs
          path: src/main/resources/natives/macos-arm64
          
      - name: Build JAR with all native libraries
        run: ./gradlew build
        
      - name: Upload JAR with all native libraries
        uses: actions/upload-artifact@v4
        with:
          name: enet-jni-all-platforms
          path: build/libs/*.jar

      - name: Publish to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
